= Memuser API Guide
Gary Clayburg;
:doctype: book
:icons: font
:source-highlighter: highlightjs
//:highlightjsdir: highlight
:toc: left
:toclevels: 4
:sectlinks:

[[overview]]
= Overview

Memuser is a simple tool for storing and retrieving user information.  All data is stored in memory, nothing is persisted.  The API used is based loosely on the SCIM protocol, which is essentially JSON with some standardized semantics.

Why: Memuser was created to help with testing some security integration scenarios without having to deal with the overhead of persisting user information.  After you have done this kind of testing for a while, it can get tedious to provision databases, start them up, tear them down.  We want to be able to test out User data integration scenarios and not worry so much about the normal data lifecycle issues.  Of course, in production you will need to deal with these issues, but we don't want them to hinder our ability to model the lifecycle of user information when we are building out our user security model.


If you have a tool that can speak SCIM, you can use Memuser

[[create-user]]
== Create

Lets jump into creating a user.  When Memuser is started, there are no users loaded.  Lets create one:

[source,indent=0,role="primary"]
.Curl
include::{snippets}/createalice/curl-request.adoc[]

[source,indent=0,role="secondary"]
.Httpie
include::{snippets}/createalice/httpie-request.adoc[]

[source,indent=0,role="secondary"]
.Http
include::{snippets}/createalice/http-request.adoc[]

TIP: We show 3 different ways to generate a JSON request - the ubiquitous https://curl.haxx.se/[curl], https://httpie.org/[HTTPie] and raw HTTP

This is a minimal user.  Only the `userName` field is required.

You should get this response:

include::{snippets}/createalice/http-response.adoc[]

The returned JSON response includes the exact user that the Memuser server created. The server generated the extra fields as per the SCIM spec.

=== GET user

Take a look at the `id` field.  This was generated by Memuser and is guaranteed to be unique and never changing among all users that it knows about.  `id` is also part of `meta.location`.  We use this field to retrieve our generated user:

[source,indent=0,role="primary"]
.Curl
include::{snippets}/getalice/curl-request.adoc[]

[source,indent=0,role="secondary"]
.Httpie
include::{snippets}/getalice/httpie-request.adoc[]

[source,indent=0,role="secondary"]
.Http
include::{snippets}/getalice/http-request.adoc[]


include::{snippets}/getalice/http-response.adoc[]

=== Duplicate userName

Lets try creating alice again:

[source,indent=0,role="primary"]
.Curl
include::{snippets}/createalice/curl-request.adoc[]

[source,indent=0,role="secondary"]
.Httpie
include::{snippets}/createalice/httpie-request.adoc[]

[source,indent=0,role="secondary"]
.Http
include::{snippets}/createalice/http-request.adoc[]

include::{snippets}/duplicatealicesmith/http-response.adoc[]

`userName` must be unique.


=== Change userName

Why is there both a `userName` and `id`?

One reason is that this allows users to change their userName.  For example, lets say Alice gets married to Tom Jones.  She changes her last name from Smith to Jones.  Alice is happy.  She comes in to work on Monday and updates her HR records to change her last name to Smith.  She would like to log on to her computer with alicejones and not alicesmith.  It sounds like a simple request, but it can cause headaches when we are dealing with many interconnected IT systems that require user identity.  There may be muliple places that need to get updated.  If they aren't all updated, alice would at best see strange errors.

So instead, we store the initial userName in Memuser when we first create the user.  Our client that created this user stores a reference it using `id`.  Later on, the userName for Alice can be updated by any client.  It doesn't really matter where the update comes from.  We only care about the opaque `id` of alice.

Here is how we change the userName for Alice:

[source,indent=0,role="primary"]
.Curl
include::{snippets}/changeusername/curl-request.adoc[]

[source,indent=0,role="secondary"]
.Httpie
include::{snippets}/changeusername/httpie-request.adoc[]

[source,indent=0,role="secondary"]
.Http
include::{snippets}/changeusername/http-request.adoc[]

include::{snippets}/changeusername/http-response.adoc[]

Alice's userName changes, the `id` and `meta.location` do not.

NOTE:  `displayName` no longer exists for Alice.  We changed the existing Alice with a PUT request.  Memuser will replace the entire user with what was sent in the request.  If instead we wanted Memuser to retain this during a userName change, we need to send a full PUT request like this:

[source,indent=0,role="primary"]
.Curl
include::{snippets}/changeusernamedisplayname/curl-request.adoc[]

[source,indent=0,role="secondary"]
.Httpie
include::{snippets}/changeusernamedisplayname/httpie-request.adoc[]

[source,indent=0,role="secondary"]
.Http
include::{snippets}/changeusernamedisplayname/http-request.adoc[]

include::{snippets}/changeusernamedisplayname/http-response.adoc[]


=== Create another user

Lets create a user with a few more fields:

[source,indent=0,role="primary"]
.Curl
include::{snippets}/createtom/curl-request.adoc[]

[source,indent=0,role="secondary"]
.Httpie
include::{snippets}/createtom/httpie-request.adoc[]

[source,indent=0,role="secondary"]
.Http
include::{snippets}/createtom/http-request.adoc[]

include::{snippets}/createtom/http-response.adoc[]

The fields included here are optional fields documented in the https://tools.ietf.org/html/rfc7643#section-8.1[SCIM spec].


=== Create arbitrary user

We can also create a user with fields that aren't necessarily SCIM defined fields:

[source,indent=0,role="primary"]
.Curl
include::{snippets}/createharry/curl-request.adoc[]

[source,indent=0,role="secondary"]
.Httpie
include::{snippets}/createharry/httpie-request.adoc[]

[source,indent=0,role="secondary"]
.Http
include::{snippets}/createharry/http-request.adoc[]

include::{snippets}/createharry/http-response.adoc[]

Here, we are using Memuser to model an application that expects users to have a `mailcode` and `emailaddress` top-level fields.

=== Get User List

Here is a standard SCIM style request to retrieve a list of our users:

[source,indent=0,role="primary"]
.Curl
include::{snippets}/getlist/curl-request.adoc[]

[source,indent=0,role="secondary"]
.Httpie
include::{snippets}/getlist/httpie-request.adoc[]

[source,indent=0,role="secondary"]
.Http
include::{snippets}/getlist/http-request.adoc[]

include::{snippets}/getlist/http-response.adoc[]


[[overview-http-verbs]]
== HTTP verbs

RESTful notes tries to adhere as closely as possible to standard HTTP and REST conventions in its
use of HTTP verbs.

|===
| Verb | Usage

| `GET`
| Used to retrieve a resource

| `POST`
| Used to create a new resource

| `PATCH`
| Used to update an existing resource, including partial updates

| `DELETE`
| Used to delete an existing resource
|===

[[overview-http-status-codes]]
== HTTP status codes

RESTful notes tries to adhere as closely as possible to standard HTTP and REST conventions in its
use of HTTP status codes.

|===
| Status code | Usage

| `200 OK`
| The request completed successfully

| `201 Created`
| A new resource has been created successfully. The resource's URI is available from the response's
`Location` header

| `204 No Content`
| An update to an existing resource has been applied successfully

| `400 Bad Request`
| The request was malformed. The response body will include an error providing further information

| `404 Not Found`
| The requested resource did not exist
|===

[[overview-errors]]
== Errors

TBD

